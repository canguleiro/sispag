<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Paginação - SisPag</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Configuração do Tailwind para modo escuro e cores customizadas -->
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
            extend: {
                colors: {
                    'sispag-yellow': '#f9d000',
                }
            }
        }
      }
    </script>

    <!-- Bibliotecas Externas (JS) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.7.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.2/dist/FileSaver.min.js"></script>
    
    <!-- Ícones (Font Awesome) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <style>
        /* Estilo para a fonte e para a scrollbar */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Scrollbar modo claro */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Scrollbar modo escuro */
        .dark ::-webkit-scrollbar-track { background: #1f2937; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        /* Estilo para a linha sendo arrastada */
        .dragging {
            opacity: 0.5;
            background: #374151;
        }
        /* Estilo para indicar onde a linha pode ser solta */
        .drag-over {
            border-top: 2px dashed #60a5fa;
        }
        /* Ajuste para ícone de cadeado */
        .lock-icon-container svg {
             transition: fill 0.2s ease-in-out;
        }
    </style>
</head>
<body class="bg-slate-100 text-gray-800 dark:bg-[#204966] dark:text-gray-200">

    <div class="container mx-auto p-4 md:p-6">

        <!-- CABEÇALHO -->
        <header class="flex flex-col sm:flex-row justify-between items-center mb-6 pb-4 border-b border-gray-200 dark:border-gray-700">
            <div class="flex items-center gap-4 mb-4 sm:mb-0">
                <img src="https://elegis.al.rn.leg.br/elegis-api/elegis-api/parametro/brasao" class="h-16" alt="Brasão ALRN">
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white">SisPag - Revista ALRN</h1>
            </div>
            <div id="cabecalho-acoes" class="flex flex-wrap gap-2 justify-center">
                <!-- Botões de ação do cabeçalho preenchidos pelo JS -->
            </div>
        </header>

        <!-- TABELA DE ROTEIRO -->
        <main class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-x-auto">
            <table id="tabelaRoteiro" class="w-full text-sm text-left">
                <thead class="bg-gray-50 dark:bg-gray-700 text-xs text-gray-500 dark:text-gray-300 uppercase">
                    <tr>
                        <th scope="col" class="px-2 py-3 w-12 text-center">#</th>
                        <th scope="col" class="px-4 py-3 w-32">Página</th>
                        <th scope="col" class="px-4 py-3">Chapéu</th>
                        <th scope="col" class="px-4 py-3">Título</th>
                        <th scope="col" class="px-4 py-3">Observações</th>
                        <th scope="col" class="px-4 py-3 w-40 align-top">
                            Redator
                            <select id="filtro-redator" class="w-full mt-1 text-xs p-1 rounded bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 border-gray-300 dark:border-gray-500 focus:outline-none">
                                <!-- Options populated by JS -->
                            </select>
                        </th>
                        <th scope="col" class="px-4 py-3 w-36">EDIÇÃO</th>
                        <th scope="col" class="px-4 py-3 w-40 text-center">Ação</th>
                    </tr>
                </thead>
                <tbody id="roteiroBody">
                    <!-- Linhas da tabela serão inseridas aqui pelo JavaScript -->
                </tbody>
            </table>
        </main>
        
        <!-- RODAPÉ COM AÇÕES -->
        <footer id="rodape-acoes" class="flex flex-wrap gap-2 justify-center mt-6">
             <!-- Botões de ação do rodapé preenchidos pelo JS -->
        </footer>

    </div>

    <!-- TEMPLATE PARA NOVAS LINHAS (MAIS EFICIENTE) -->
    <template id="linha-template">
        <tr class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50 align-middle transition-colors duration-200 cursor-grab" draggable="true">
            <td class="px-2 py-2 text-center text-gray-400 font-medium lock-icon-container cursor-pointer" title="Clique para fixar/desfixar a linha">
                <svg xmlns="http://www.w3.org/2000/svg" height="18" width="18" viewBox="0 0 448 512" class="mx-auto" fill="#9ca3af"><path d="M144 144v48h160v-48c0-44.2-35.8-80-80-80s-80 35.8-80 80zM80 192V144C80 64.5 144.5 0 224 0s144 64.5 144 144v48h16c35.3 0 64 28.7 64 64v192c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V256c0-35.3 28.7-64 64-64h16z"/></svg>
            </td>
            <td class="px-4 py-2"><input type="text" placeholder="Página" class="bg-transparent w-full focus:outline-none font-semibold" disabled></td>
            <td class="px-4 py-2"><input type="text" placeholder="Chapéu" class="bg-gray-200 dark:bg-gray-700 w-full p-2 rounded-md border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:text-white"></td>
            <td class="px-4 py-2"><input type="text" placeholder="Título" class="bg-gray-200 dark:bg-gray-700 w-full p-2 rounded-md border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:text-white"></td>
            <td class="px-4 py-2"><input type="text" placeholder="Observações" class="bg-gray-200 dark:bg-gray-700 w-full p-2 rounded-md border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:text-white"></td>
            <td class="px-4 py-2">
                <select class="redator-select bg-gray-200 dark:bg-gray-700 w-full p-2 rounded-md border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:text-white">
                    <option value="">Selecione</option>
                    <!-- Options populated by JS -->
                </select>
            </td>
            <td class="px-4 py-2">
                <select class="statusSelect w-full p-2 rounded-md border border-gray-300 dark:border-gray-600 font-bold focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200">
                    <option value="Pendente">Pendente</option>
                    <option value="Atualizar">Atualizar</option>
                    <option value="Editada">Editada</option>
                </select>
            </td>
            <td class="px-4 py-2">
                <div class="flex items-center justify-center gap-2">
                    <button class="btn-adicionar h-8 w-8 flex items-center justify-center rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors" title="Adicionar linha abaixo"><i class="fas fa-plus text-green-500 dark:text-green-400"></i></button>
                    <button class="btn-excluir h-8 w-8 flex items-center justify-center rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors" title="Excluir linha"><i class="fas fa-minus text-red-500 dark:text-red-400"></i></button>
                    <button class="btn-entregue h-8 w-8 flex items-center justify-center rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors" title="Marcar como entregue"><i class="fas fa-check-circle text-gray-400 dark:text-gray-500"></i></button>
                </div>
            </td>
        </tr>
    </template>

    <!-- CONTAINER PARA NOTIFICAÇÕES (TOASTS) -->
    <div id="notification-container" class="fixed bottom-5 right-5 z-50 flex flex-col gap-3"></div>

    <!-- CONTAINER PARA MODAL DE CONFIRMAÇÃO -->
    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden items-center justify-center"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // =================================================================================
        // Elementos do DOM e Configurações
        // =================================================================================
        const tabelaBody = document.getElementById('roteiroBody');
        const linhaTemplate = document.getElementById('linha-template');
        const cabecalhoAcoes = document.getElementById('cabecalho-acoes');
        const rodapeAcoes = document.getElementById('rodape-acoes');
        
        const statusColors = {
            'Pendente': 'bg-red-500 text-white',
            'Atualizar': 'bg-sispag-yellow text-gray-900 font-bold',
            'Editada': 'bg-green-500 text-white',
        };

        const redatores = ["Agência", "Anninha", "Camilo", "Denise", "Eduardo Maia", "Gabriela", "Gerlane", "João Gilberto", "Julio", "Juliana", "Mariana Rocha", "Marília", "Mulatinho", "Rafaela", "Sayonara", "Thaisa", "Colaborador"].sort();

        // =================================================================================
        // Funções Principais de Manipulação da Tabela
        // =================================================================================

        function adicionarLinha(data = {}, refNode = null) {
            const clone = linhaTemplate.content.cloneNode(true);
            const novaLinha = clone.querySelector('tr');
            const inputs = novaLinha.querySelectorAll('input, select');
            const selectRedator = novaLinha.querySelector('.redator-select');

            // Popula a lista de redatores dinamicamente
            redatores.forEach(r => {
                const option = document.createElement('option');
                option.value = r;
                option.textContent = r;
                selectRedator.appendChild(option);
            });

            if (data.paginaFixa) {
                novaLinha.dataset.paginaFixa = 'true';
            }

            novaLinha.dataset.fixado = data.fixado || false;
            novaLinha.dataset.entregue = data.entregue || false;

            inputs[0].value = data.pagina || '';
            inputs[1].value = data.chapeu || '';
            inputs[2].value = data.titulo || '';
            inputs[3].value = data.observacoes || '';
            selectRedator.value = data.redator || '';
            inputs[5].value = data.status || 'Pendente';
            
            toggleFixarEstado(novaLinha, novaLinha.dataset.fixado === 'true');
            toggleEntregueEstado(novaLinha, novaLinha.dataset.entregue === 'true');
            mudarCorSelect(inputs[5]);

            if (refNode) {
                tabelaBody.insertBefore(novaLinha, refNode.nextSibling);
            } else {
                tabelaBody.appendChild(novaLinha);
            }
            renumerarPaginas();
            atualizarFiltroRedator();
            return novaLinha;
        }

        function excluirLinha(linha) {
            if (linha.dataset.fixado === 'true') {
                showNotification('Esta linha está fixada e não pode ser excluída.', 'error');
                return;
            }
            linha.remove();
            renumerarPaginas();
            atualizarFiltroRedator();
        }

        function renumerarPaginas() {
            let paginaAtual = 4;
            tabelaBody.querySelectorAll('tr').forEach(linha => {
                const paginaInput = linha.querySelector('td:nth-child(2) input');

                if (linha.dataset.paginaFixa === 'true') {
                    return;
                }
                paginaInput.value = `${paginaAtual} e ${paginaAtual + 1}`;
                paginaAtual += 2;
            });
        }
        
        function toggleFixarEstado(linha, fixado) {
            const lockIcon = linha.querySelector('.lock-icon-container svg');
            linha.dataset.fixado = fixado;
            linha.draggable = !fixado;
            linha.style.cursor = fixado ? 'default' : 'grab';
            lockIcon.setAttribute('fill', fixado ? '#3b82f6' : '#9ca3af'); 
        }

        function toggleEntregueEstado(linha, entregue) {
            const icon = linha.querySelector('.btn-entregue i');
            linha.dataset.entregue = entregue;
            icon.classList.toggle('text-blue-500', entregue);
            icon.classList.toggle('dark:text-blue-400', entregue);
            icon.classList.toggle('text-gray-400', !entregue);
            icon.classList.toggle('dark:text-gray-500', !entregue);
        }

        // =================================================================================
        // Funções de Persistência de Dados (localStorage e JSON)
        // =================================================================================

        function getTableData() {
            return Array.from(tabelaBody.querySelectorAll('tr')).map(linha => {
                const inputs = linha.querySelectorAll('input, select');
                return {
                    pagina: inputs[0].value,
                    chapeu: inputs[1].value,
                    titulo: inputs[2].value,
                    observacoes: inputs[3].value,
                    redator: linha.querySelector('.redator-select').value,
                    status: linha.querySelector('.statusSelect').value,
                    fixado: linha.dataset.fixado === 'true',
                    entregue: linha.dataset.entregue === 'true',
                    paginaFixa: linha.dataset.paginaFixa === 'true'
                };
            });
        }
        
        function loadTableData(dados) {
            tabelaBody.innerHTML = '';
            const paginasPermanentes = ['Capa', '2', '3', 'Contracapa'];

            dados.forEach(data => {
                if (paginasPermanentes.includes(data.pagina)) {
                    data.paginaFixa = true;
                    data.fixado = data.fixado !== false; // Mantém fixado por padrão
                }

                const novaLinha = adicionarLinha(data);
                if (data.paginaFixa) {
                    const inputs = novaLinha.querySelectorAll('input[type="text"], select');
                    inputs[0].disabled = true;
                    if(['GALERIA DOS DEPUTADOS', 'PALAVRA DO PRESIDENTE', 'SUMÁRIO E EXPEDIENTE', 'AGORA É LEI!', 'RN EM FOTOS', 'PRODUÇÃO E SERVIÇOS', 'LINHA DO TEMPO', 'ELES FAZEM A ALRN', 'FRASES DOS DEPUTADOS'].includes(data.chapeu)){
                        inputs[1].disabled = true;
                    }
                }
            });
            renumerarPaginas();
            document.getElementById('filtro-redator').value = 'Todos';
            atualizarFiltroRedator();
            filtrarTabela();
        }

        function salvarDados() {
            localStorage.setItem('roteiroRevista', JSON.stringify(getTableData()));
            showNotification('Dados salvos com sucesso!');
        }

        function carregarDados() {
            const dadosSalvos = localStorage.getItem('roteiroRevista');
            if (dadosSalvos) {
                loadTableData(JSON.parse(dadosSalvos));
                showNotification('Dados carregados com sucesso!');
            } else {
                showNotification('Nenhum dado salvo encontrado.', 'info');
            }
        }

        function limparDados() {
            showConfirmationModal('Tem certeza que deseja apagar todos os dados? Esta ação não pode ser desfeita.', () => {
                localStorage.removeItem('roteiroRevista');
                preencherTabelaInicial();
                showNotification('Dados limpos e tabela reiniciada.');
            });
        }

        function exportarJSON() {
            const data = getTableData();
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            saveAs(blob, 'roteiro_revista.json');
        }

        function importarJSON() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        const data = JSON.parse(event.target.result);
                        loadTableData(data);
                        showNotification('Arquivo JSON importado com sucesso!');
                    } catch (error) {
                        showNotification('Erro ao ler o arquivo JSON.', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // =================================================================================
        // Funções de Exportação (PDF e ZIP)
        // =================================================================================

        function criarCabecalhoPDF(doc) {
            const dataAtual = new Date();
            const dataFormatada = dataAtual.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const horaFormatada = dataAtual.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            const titulo = `Revista ALRN 2025`;

            doc.setFontSize(10);
            doc.text(`Data: ${dataFormatada} Hora: ${horaFormatada}`, 230, 10);
            
            doc.setFillColor(32, 73, 102);
            doc.rect(14, 4.5, 45, 7, 'F');
            doc.setFontSize(14);
            doc.setTextColor('#ffffff');
            doc.text(titulo, 15, 10);
            doc.setTextColor('#000000');
            return titulo;
        }

        function exportarPDF(resumo = false) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape');
            const titulo = criarCabecalhoPDF(doc);
            const data = getTableData().map(linha => {
                const row = [linha.pagina, linha.chapeu, linha.titulo, linha.observacoes];
                if (!resumo) row.push(linha.redator);
                row.push(linha.status);
                return row;
            });
            const headers = resumo ? 
                [["PÁGINA", "CHAPÉU", "TÍTULO", "OBSERVAÇÕES", "EDIÇÃO"]] :
                [["PÁGINA", "CHAPÉU", "TÍTULO", "OBSERVAÇÕES", "REDATOR", "EDIÇÃO"]];

            doc.autoTable({
                head: headers,
                body: data,
                startY: 20,
                theme: 'grid',
                headStyles: { fillColor: [229, 229, 229], textColor: [0, 0, 0], fontSize: 10 },
                styles: { lineColor: [193, 193, 193], lineWidth: 0.1, fontSize: 10 }
            });

            doc.save(`Roteiro_${titulo}${resumo ? '_resumo' : ''}.pdf`);
        }

        function criarPastasDeArquivo() {
            const zip = new JSZip();
            const data = getTableData();
            data.forEach(linha => {
                if (linha.chapeu && linha.titulo) {
                    const pastaNome = `${linha.chapeu}_${linha.titulo}`.replace(/[^a-zA-Z0-9_]/g, '_');
                    const pasta = zip.folder(pastaNome);
                    pasta.folder('fotos_de_apoio');
                    pasta.file('observacoes.txt', linha.observacoes || '');
                }
            });

            const anoAtual = new Date().getFullYear();
            zip.generateAsync({ type: 'blob' }).then(blob => {
                saveAs(blob, `Revista ALRN_${anoAtual}.zip`);
            });
        }
        
        function mostrarAjuda() {
            const ajudaHTML = `
                <div class="bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 rounded-lg shadow-xl p-6 w-full max-w-2xl relative">
                    <button id="fechar-ajuda" class="absolute top-3 right-3 text-gray-400 hover:text-white">&times;</button>
                    <h2 class="text-2xl font-bold mb-4">Guia de Uso - SisPag</h2>
                    <div class="text-sm space-y-3 max-h-[70vh] overflow-y-auto pr-2">
                        <p>O SisPag é uma ferramenta para gerenciar o roteiro de páginas de uma publicação de forma eficiente.</p>
                        <h3 class="font-semibold text-lg mt-4">Funcionalidades Principais:</h3>
                        <ul class="list-disc list-inside space-y-1">
                            <li><strong>Adicionar/Excluir Linha:</strong> Use os ícones <i class="fas fa-plus"></i> e <i class="fas fa-minus"></i> para gerenciar as linhas.</li>
                            <li><strong>Reordenar Linhas:</strong> Clique e arraste uma linha para reordená-la. A numeração das páginas é atualizada automaticamente.</li>
                            <li><strong>Fixar Linha:</strong> Clique no ícone de cadeado <i class="fas fa-lock"></i> para impedir que uma linha seja movida ou excluída.</li>
                            <li><strong>Marcar como Entregue:</strong> Clique no ícone de check <i class="fas fa-check-circle text-blue-500"></i> para indicar que a matéria foi entregue.</li>
                            <li><strong>Salvar/Carregar:</strong> Salve seu progresso no navegador com "Salvar Dados" e recupere-o com "Carregar Dados".</li>
                            <li><strong>Importar/Exportar:</strong> Compartilhe seu roteiro com outros usando os botões "Importar" e "Exportar" (formato .json).</li>
                            <li><strong>Gerar PDF:</strong> Exporte a tabela para um arquivo PDF, em versão completa ou resumida.</li>
                            <li><strong>Estruturar:</strong> Crie um arquivo .zip com uma estrutura de pastas baseada no seu roteiro.</li>
                        </ul>
                    </div>
                </div>`;
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = ajudaHTML;
            modalContainer.classList.remove('hidden');
            modalContainer.classList.add('flex');
            
            document.getElementById('fechar-ajuda').addEventListener('click', () => {
                modalContainer.classList.add('hidden');
                modalContainer.classList.remove('flex');
                modalContainer.innerHTML = '';
            });
        }


        // =================================================================================
        // Funções de UI Auxiliares (Tema, Cores, Notificações, Modal, Filtros)
        // =================================================================================

        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            const isDarkMode = document.documentElement.classList.contains('dark');
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            updateThemeIcon();
        }

        function updateThemeIcon() {
            const isDarkMode = document.documentElement.classList.contains('dark');
            document.querySelectorAll('[data-action="theme"] i').forEach(icon => {
                icon.className = isDarkMode ? 'fas fa-sun' : 'fas fa-moon';
            });
        }
        
        function mudarCorSelect(selectElement) {
            Object.values(statusColors).forEach(cls => selectElement.classList.remove(...cls.split(' ')));
            const statusColor = statusColors[selectElement.value] || '';
            selectElement.classList.add(...statusColor.split(' '));
            if (!statusColor) {
                selectElement.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-800', 'dark:text-white');
            }
        }

        function showNotification(message, type = 'success') {
            const container = document.getElementById('notification-container');
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };
            const notification = document.createElement('div');
            notification.className = `text-white p-3 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full opacity-0 ${colors[type]}`;
            notification.textContent = message;
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.remove('translate-x-full', 'opacity-0');
            }, 10);

            setTimeout(() => {
                notification.classList.add('translate-x-full', 'opacity-0');
                notification.addEventListener('transitionend', () => notification.remove());
            }, 3000);
        }

        function showConfirmationModal(message, onConfirm) {
            const modalContainer = document.getElementById('modal-container');
            const modal = document.createElement('div');
            modal.className = 'bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 rounded-lg shadow-xl p-6 w-full max-w-sm';
            modal.innerHTML = `
                <p class="mb-6">${message}</p>
                <div class="flex justify-end gap-4">
                    <button id="confirm-cancel" class="px-4 py-2 rounded bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors">Cancelar</button>
                    <button id="confirm-ok" class="px-4 py-2 rounded bg-red-600 hover:bg-red-500 text-white transition-colors">Confirmar</button>
                </div>`;
            modalContainer.innerHTML = '';
            modalContainer.appendChild(modal);
            modalContainer.classList.remove('hidden');
            modalContainer.classList.add('flex');

            const closeModal = () => {
                modalContainer.classList.add('hidden');
                modalContainer.classList.remove('flex');
            };

            document.getElementById('confirm-ok').onclick = () => {
                onConfirm();
                closeModal();
            };
            document.getElementById('confirm-cancel').onclick = closeModal;
        }

        function filtrarTabela() {
            const redatorFiltro = document.getElementById('filtro-redator').value;
            tabelaBody.querySelectorAll('tr').forEach(linha => {
                const redatorLinha = linha.querySelector('.redator-select').value;
                const mostrar = (redatorFiltro === 'Todos' || redatorLinha === redatorFiltro);
                linha.style.display = mostrar ? '' : 'none';
            });
        }

        function atualizarFiltroRedator() {
            const filtro = document.getElementById('filtro-redator');
            const valorSelecionado = filtro.value;

            const counts = {};
            redatores.forEach(r => { 
                if (r) counts[r] = { total: 0, entregues: 0 }; 
            });

            let totalAtribuido = 0;
            let totalEntregues = 0;

            tabelaBody.querySelectorAll('tr').forEach(linha => {
                const redatorLinha = linha.querySelector('.redator-select').value;
                const isEntregue = linha.dataset.entregue === 'true';

                if (redatorLinha && redatores.includes(redatorLinha)) {
                    counts[redatorLinha].total++;
                    totalAtribuido++;
                    if (isEntregue) {
                        counts[redatorLinha].entregues++;
                        totalEntregues++;
                    }
                }
            });

            filtro.innerHTML = ''; 

            const optionTodos = document.createElement('option');
            optionTodos.value = 'Todos';
            optionTodos.textContent = `Todos (${totalEntregues}/${totalAtribuido})`;
            filtro.appendChild(optionTodos);

            redatores.forEach(r => {
                if (r) {
                    const option = document.createElement('option');
                    option.value = r;
                    option.textContent = `${r} (${counts[r].entregues}/${counts[r].total})`;
                    filtro.appendChild(option);
                }
            });

            if (Array.from(filtro.options).some(opt => opt.value === valorSelecionado)) {
                filtro.value = valorSelecionado;
            } else {
                filtro.value = 'Todos';
            }
        }
        
        // =================================================================================
        // Listeners de Eventos (Centralizados)
        // =================================================================================

        function setupEventListeners() {
            document.getElementById('filtro-redator').addEventListener('change', filtrarTabela);

            tabelaBody.addEventListener('click', e => {
                const target = e.target;
                const linha = target.closest('tr');
                if (!linha) return;

                // Toggle Fixar
                if (target.closest('.lock-icon-container')) {
                    const isFixado = linha.dataset.fixado === 'true';
                    toggleFixarEstado(linha, !isFixado);
                    return;
                }
                
                // Botões de Ação
                const button = target.closest('button');
                if (!button) return;

                if (button.classList.contains('btn-adicionar')) {
                    adicionarLinha({}, linha);
                } else if (button.classList.contains('btn-excluir')) {
                    excluirLinha(linha);
                } else if (button.classList.contains('btn-entregue')) {
                    const isEntregue = linha.dataset.entregue === 'true';
                    toggleEntregueEstado(linha, !isEntregue);
                    atualizarFiltroRedator();
                }
            });

            tabelaBody.addEventListener('change', e => {
                const target = e.target;
                if (target.classList.contains('statusSelect')) {
                    mudarCorSelect(target);
                }
                if (target.classList.contains('redator-select')) {
                    atualizarFiltroRedator();
                }
            });

            // --- Listeners de Drag and Drop ---
            let draggedItem = null;
            tabelaBody.addEventListener('dragstart', e => {
                const targetRow = e.target.closest('tr');
                if (targetRow.dataset.fixado === 'true') {
                    e.preventDefault();
                    return;
                }
                draggedItem = targetRow;
                setTimeout(() => {
                    draggedItem.classList.add('dragging');
                }, 0);
            });
            
            tabelaBody.addEventListener('dragend', e => {
                if(draggedItem) {
                    draggedItem.classList.remove('dragging');
                    draggedItem = null;
                    document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                }
            });

            tabelaBody.addEventListener('dragover', e => {
                e.preventDefault();
                const target = e.target.closest('tr');
                if (target && target !== draggedItem && target.dataset.fixado !== 'true') {
                    document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                    target.classList.add('drag-over');
                }
            });

            tabelaBody.addEventListener('dragleave', e => {
                 const target = e.target.closest('tr');
                 if(target) {
                    target.classList.remove('drag-over');
                 }
            });

            tabelaBody.addEventListener('drop', e => {
                e.preventDefault();
                const target = e.target.closest('tr');
                if (draggedItem && target && target !== draggedItem && target.dataset.fixado !== 'true') {
                    tabelaBody.insertBefore(draggedItem, target);
                    renumerarPaginas();
                }
                 document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            });
        }
        
        // =================================================================================
        // Inicialização da Aplicação
        // =================================================================================

        function preencherTabelaInicial() {
            const linhasFixas = [
                { pagina: 'Capa', chapeu: '', titulo: '', observacoes: '', redator: '', status: 'Pendente', paginaFixa: true, fixado: true, entregue: false },
                { pagina: '2', chapeu: 'GALERIA DOS DEPUTADOS', titulo: '', observacoes: '', redator: '', status: 'Pendente', paginaFixa: true, fixado: true, entregue: false },
                { pagina: '3', chapeu: 'PALAVRA DO PRESIDENTE', titulo: '', observacoes: '', redator: '', status: 'Pendente', paginaFixa: true, fixado: true, entregue: false },
                { pagina: '', chapeu: 'SUMÁRIO E EXPEDIENTE', titulo: '', observacoes: '', redator: '', status: 'Pendente', entregue: false },
                { pagina: '', chapeu: 'AGORA É LEI!', titulo: '', observacoes: '', redator: '', status: 'Pendente', entregue: false },
                { pagina: '', chapeu: 'RN EM FOTOS', titulo: '', observacoes: '', redator: '', status: 'Pendente', entregue: false },
                { pagina: '', chapeu: 'RN EM FOTOS', titulo: '', observacoes: '', redator: '', status: 'Pendente', entregue: false },
                { pagina: '', chapeu: 'PRODUÇÃO E SERVIÇOS', titulo: '', observacoes: '', redator: '', status: 'Pendente', entregue: false },
                { pagina: '', chapeu: 'LINHA DO TEMPO', titulo: '', observacoes: '', redator: '', status: 'Pendente', entregue: false },
                { pagina: '', chapeu: 'ELES FAZEM A ALRN', titulo: '', observacoes: '', redator: '', status: 'Pendente', entregue: false },
                { pagina: '', chapeu: 'FRASES DOS DEPUTADOS', titulo: '', observacoes: '', redator: '', status: 'Pendente', entregue: false },
                { pagina: '', chapeu: 'FRASES DOS DEPUTADOS', titulo: '', observacoes: '', redator: '', status: 'Pendente', entregue: false },
                { pagina: '', chapeu: 'FRASES DOS DEPUTADOS', titulo: '', observacoes: '', redator: '', status: 'Pendente', entregue: false },
                { pagina: 'Contracapa', chapeu: '', titulo: '', observacoes: '', redator: '', status: 'Pendente', paginaFixa: true, fixado: true, entregue: false },
            ];
            loadTableData(linhasFixas);
        }
        
        function popularBotoesDeAcao() {
             const acoes = `
                <button data-action="salvar" title="Salvar" class="h-10 w-10 flex items-center justify-center text-white bg-gray-500 rounded-full hover:bg-gray-600 transition-colors"><i class="fas fa-save"></i></button>
                <button data-action="carregar" title="Carregar" class="h-10 w-10 flex items-center justify-center text-white bg-gray-500 rounded-full hover:bg-gray-600 transition-colors"><i class="fas fa-upload"></i></button>
                <button data-action="limpar" title="Limpar" class="h-10 w-10 flex items-center justify-center text-white bg-gray-500 rounded-full hover:bg-gray-600 transition-colors"><i class="fas fa-trash-alt"></i></button>
                <button data-action="importar" title="Importar" class="h-10 w-10 flex items-center justify-center text-white bg-teal-600 rounded-full hover:bg-teal-700 transition-colors"><i class="fas fa-file-import"></i></button>
                <button data-action="exportar" title="Exportar" class="h-10 w-10 flex items-center justify-center text-white bg-teal-600 rounded-full hover:bg-teal-700 transition-colors"><i class="fas fa-file-export"></i></button>
                <div class="relative inline-block text-left group">
                    <button title="Gerar PDF" class="h-10 w-10 flex items-center justify-center text-white bg-purple-600 rounded-full hover:bg-purple-700 transition-colors"><i class="fas fa-file-pdf"></i></button>
                    <div class="origin-top-right absolute right-0 mt-0 w-56 rounded-md shadow-lg bg-white dark:bg-gray-700 ring-1 ring-black ring-opacity-5 z-10 hidden group-hover:block">
                        <div class="py-1">
                            <a href="#" data-action="pdfCompleto" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">Roteiro Completo</a>
                            <a href="#" data-action="pdfResumo" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">Roteiro Resumo</a>
                        </div>
                    </div>
                </div>
                <button data-action="estruturar" title="Estruturar" class="h-10 w-10 flex items-center justify-center text-white bg-purple-600 rounded-full hover:bg-purple-700 transition-colors"><i class="fas fa-folder-plus"></i></button>
                <button data-action="ajuda" title="Ajuda" class="h-10 w-10 flex items-center justify-center text-white bg-gray-500 rounded-full hover:bg-gray-600 transition-colors"><i class="fas fa-question-circle"></i></button>
                <button data-action="theme" title="Alterar Tema" class="h-10 w-10 flex items-center justify-center text-white bg-gray-500 rounded-full hover:bg-gray-600 transition-colors"><i class="fas fa-sun"></i></button>
             `;
             cabecalhoAcoes.innerHTML = acoes;
             rodapeAcoes.innerHTML = acoes;
             
             document.querySelectorAll('[data-action]').forEach(el => {
                 el.addEventListener('click', (e) => {
                     e.preventDefault();
                     switch(e.currentTarget.dataset.action) {
                         case 'salvar': salvarDados(); break;
                         case 'carregar': carregarDados(); break;
                         case 'limpar': limparDados(); break;
                         case 'importar': importarJSON(); break;
                         case 'exportar': exportarJSON(); break;
                         case 'pdfCompleto': exportarPDF(false); break;
                         case 'pdfResumo': exportarPDF(true); break;
                         case 'estruturar': criarPastasDeArquivo(); break;
                         case 'ajuda': mostrarAjuda(); break;
                         case 'theme': toggleTheme(); break;
                     }
                 });
             });
             updateThemeIcon();
        }

        function init() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                document.documentElement.classList.remove('dark');
            } else {
                document.documentElement.classList.add('dark');
            }
            
            popularBotoesDeAcao();

            if (!localStorage.getItem('roteiroRevista')) {
                preencherTabelaInicial();
            } else {
                carregarDados();
            }
            setupEventListeners();
        }

        init();
    });
    </script>
</body>
</html>

